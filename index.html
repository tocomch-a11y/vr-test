<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>PSY-AR FINAL STABLE</title>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        #arBtn { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); 
            padding: 40px 60px; font-size: 24px; background: #00ff00; color: #000; 
            border: none; border-radius: 50px; z-index: 99999; 
            font-weight: bold; cursor: pointer; box-shadow: 0 0 30px #0f0;
        }
    </style>
</head>
<body>
    <button id="arBtn">START AR EXPERIENCE</button>
    <audio id="audio" autoplay playsinline></audio>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>

    <script>
        let scene, camera, renderer, mesh, xrRefSpace;
        let geometries = [];
        window.mD = { low: 0, mid: 0, high: 0, trigger: false };
        let lastSwitch = 0, hue = 0;

        // 12パターンの幾何学
        function initGeos() {
            geometries = [
                new THREE.TorusKnotGeometry(0.3, 0.1, 128, 16, 2, 3),
                new THREE.IcosahedronGeometry(0.5, 2),
                new THREE.TorusGeometry(0.5, 0.2, 32, 100),
                new THREE.OctahedronGeometry(0.6, 0),
                new THREE.TorusKnotGeometry(0.4, 0.05, 200, 32, 7, 11),
                new THREE.DodecahedronGeometry(0.5, 1),
                new THREE.BoxGeometry(0.5, 0.5, 0.5, 8, 8, 8),
                new THREE.SphereGeometry(0.5, 12, 12),
                new THREE.TorusKnotGeometry(0.3, 0.15, 128, 32, 3, 4),
                new THREE.CylinderGeometry(0.4, 0.4, 1, 32, 1, true),
                new THREE.TorusGeometry(0.4, 0.3, 10, 8),
                new THREE.CapsuleGeometry(0.3, 0.4, 8, 16)
            ];
        }

        const btn = document.getElementById('arBtn');

        // AR起動
        async function startAR() {
            if (!navigator.xr) return alert("HTTPSでアクセスしてください");

            try {
                // セッションを要求
                const session = await navigator.xr.requestSession('immersive-ar', {
                    optionalFeatures: ['local-floor', 'hand-tracking']
                });
                
                // レンダラー設定
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.xr.enabled = true;
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);

                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(70, window.innerWidth / window.innerHeight, 0.01, 20);
                
                initGeos();
                mesh = new THREE.Mesh(geometries[0], new THREE.MeshBasicMaterial({ wireframe: true, color: 0x00ff00 }));
                scene.add(mesh);

                const ref = await session.requestReferenceSpace('local-floor');
                xrRefSpace = ref;
                await renderer.xr.setSession(session);
                
                initPeer();
                renderer.setAnimationLoop(render);

                btn.style.display = 'none';

                session.addEventListener('end', () => {
                    window.location.reload();
                });

            } catch (e) {
                alert("AR Start Failed: " + e.message + "\nページをリロードして5秒待ってから再試行してください。");
            }
        }

        btn.onclick = () => {
            startAR();
        };

        function initPeer() {
            const peer = new Peer('quest-receiver');
            peer.on('connection', conn => {
                conn.on('data', d => {
                    window.mD = { ...window.mD, ...d };
                });
            });
            peer.on('call', call => {
                call.answer(new MediaStream());
                call.on('stream', s => { 
                    const aud = document.getElementById('audio');
                    aud.srcObject = s; aud.play(); 
                });
            });
        }

        function render(time, frame) {
            if (!frame || !xrRefSpace) return;
            hue += 0.005;
            const d = window.mD;

            // 音トリガー形状変化
            if (d.trigger && (Date.now() - lastSwitch > 300)) {
                mesh.geometry = geometries[Math.floor(Math.random() * geometries.length)];
                lastSwitch = Date.now();
            }

            // ハンドトラッキング
            const gaze = new THREE.Vector3(0, 0, -0.6).applyQuaternion(camera.quaternion).add(camera.position);
            let handPos = new THREE.Vector3(), count = 0;

            for (const input of frame.session.inputSources) {
                if (input.hand) {
                    const joint = input.hand.get('index-finger-tip');
                    const pose = joint ? frame.getJointPose(joint, xrRefSpace) : null;
                    if (pose) {
                        handPos.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
                        count++;
                    }
                }
            }

            if (count > 0) {
                mesh.position.lerp(handPos, 0.2);
                mesh.rotation.y += 0.05 + (d.high * 2.0);
            } else {
                mesh.position.lerp(gaze, 0.1);
                mesh.rotation.y += 0.02;
            }

            mesh.scale.setScalar(0.4 + (d.low * 4.0));
            mesh.material.color.setHSL((hue + d.mid) % 1, 1, 0.5);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
