<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Quest AR</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #arBtn { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); padding: 50px; font-size: 30px; z-index: 10; }
    </style>
</head>
<body>
    <button id="arBtn">START AR</button>
    <audio id="audio" autoplay></audio>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script>
        let scene, camera, renderer, mesh, xrRefSpace, geometries = [];
        let macData = { low: 0, mid: 0, high: 0, trigger: false };
        let currentIdx = 0, lastSwitch = 0, hue = 0;

        const btn = document.getElementById('arBtn');
        btn.onclick = () => {
            navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['local-floor', 'hand-tracking'] })
                .then(session => {
                    btn.style.display = 'none';
                    renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true });
                    renderer.xr.enabled = true;
                    renderer.setSize(window.innerWidth, window.innerHeight);
                    scene = new THREE.Scene();
                    camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 100);
                    
                    geometries = [
                        new THREE.TorusKnotGeometry(1, 0.4, 64, 8), new THREE.IcosahedronGeometry(1.5, 1),
                        new THREE.TorusGeometry(2, 0.1, 16, 100), new THREE.OctahedronGeometry(1.5, 0),
                        new THREE.TorusKnotGeometry(1.5, 0.1, 100, 3), new THREE.BoxGeometry(2, 2, 2),
                        new THREE.DodecahedronGeometry(1.5, 0), new THREE.TorusGeometry(1.5, 0.8, 12, 6),
                        new THREE.SphereGeometry(1.5, 16, 16), new THREE.ConeGeometry(1.5, 3, 16),
                        new THREE.TorusKnotGeometry(1.2, 0.6, 64, 4), new THREE.CapsuleGeometry(1, 2, 4, 16)
                    ];
                    mesh = new THREE.Mesh(geometries[0], new THREE.MeshBasicMaterial({ wireframe: true, transparent: true }));
                    scene.add(mesh);

                    session.requestReferenceSpace('local-floor').then(ref => {
                        xrRefSpace = ref;
                        renderer.xr.setSession(session);
                        initPeer();
                        renderer.setAnimationLoop(render);
                    });
                });
        };

        function initPeer() {
            const peer = new Peer('quest-receiver');
            peer.on('connection', conn => conn.on('data', data => macData = data));
            peer.on('call', call => {
                call.answer(new MediaStream());
                call.on('stream', stream => document.getElementById('audio').srcObject = stream);
            });
        }

        function render(time, frame) {
            if (!frame || !xrRefSpace) return;
            hue += 0.005;
            if (macData.trigger && Date.now() - lastSwitch > 700) {
                currentIdx = (currentIdx + 1) % geometries.length;
                mesh.geometry = geometries[currentIdx];
                lastSwitch = Date.now();
            }
            for (const input of frame.session.inputSources) {
                if (input.hand) {
                    const pose = frame.getJointPose(input.hand.get('index-finger-tip'), xrRefSpace);
                    if (pose) mesh.position.lerp(new THREE.Vector3().copy(pose.transform.position), 0.2);
                }
            }
            mesh.scale.setScalar(1 + macData.low * 3);
            mesh.material.color.setHSL((hue + macData.mid) % 1, 0.8, 0.5);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
