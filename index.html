<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>VR Audio Visualizer - 4 Modes</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: sans-serif; }
        #overlay { position: absolute; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white; background: #000; z-index: 100; }
        .id-label { font-size: 24px; color: #00ffff; margin: 10px; padding: 10px; border: 2px solid #00ffff; border-radius: 10px; }
        button { padding: 25px 50px; font-size: 22px; background: #00ffff; color: black; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; }
        #mode-info { position: fixed; bottom: 20px; width: 100%; text-align: center; color: white; font-size: 1.5em; pointer-events: none; z-index: 50; text-shadow: 2px 2px 4px #000; }
    </style>
</head>
<body>
    <div id="overlay">
        <h1>Advanced VR Visualizer</h1>
        <div id="idLabel" class="id-label">----</div>
        <div id="actionArea"><p>Macから送信してください</p></div>
    </div>
    <div id="mode-info">ボタン(A/B/X/Y)でモード切替</div>
    <audio id="remoteAudio" autoplay></audio>

    <script type="module">
        import { VRButton } from 'https://unpkg.com/three@0.128.0/examples/jsm/webxr/VRButton.js';

        let scene, camera, renderer, analyzer, dataArray, audioCtx, remoteStream;
        let currentMode = 'A'; // A, B, X, Y
        const groups = { A: new THREE.Group(), B: new THREE.Group(), X: new THREE.Group(), Y: new THREE.Group() };
        let hueBase = 0;

        // --- PeerJS Setup ---
        const questId = 'vr-target-' + Math.floor(Math.random() * 999);
        const peer = new Peer(questId);
        peer.on('open', id => document.getElementById('idLabel').innerText = id);
        peer.on('call', call => {
            call.answer(new MediaStream());
            call.on('stream', stream => {
                remoteStream = stream;
                document.getElementById('remoteAudio').srcObject = stream;
                const btn = document.createElement('button');
                btn.innerText = "連動開始";
                btn.onclick = () => startAudioEngine(stream);
                document.getElementById('actionArea').innerHTML = "";
                document.getElementById('actionArea').appendChild(btn);
            });
        });

        async function startAudioEngine(stream) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            await audioCtx.resume();
            const source = audioCtx.createMediaStreamSource(stream);
            analyzer = audioCtx.createAnalyser();
            analyzer.fftSize = 512;
            source.connect(analyzer);
            source.connect(audioCtx.destination);
            dataArray = new Uint8Array(analyzer.frequencyBinCount);
            document.getElementById('overlay').style.display = 'none';
        }

        // --- Three.js Setup ---
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);
        document.body.appendChild(VRButton.createButton(renderer));

        // モード別オブジェクト作成
        setupModeA(); setupModeB(); setupModeX(); setupModeY();
        Object.values(groups).forEach(g => scene.add(g));
        switchMode('A');

        // --- モード A: 流れる光のトンネル (酔いにくい直線移動) ---
        function setupModeA() {
            const geo = new THREE.CylinderGeometry(20, 20, 400, 32, 40, true);
            const mat = new THREE.MeshBasicMaterial({ wireframe: true, transparent: true, opacity: 0.5 });
            const tunnel = new THREE.Mesh(geo, mat);
            tunnel.rotation.x = Math.PI/2;
            groups.A.add(tunnel);
        }

        // --- モード B: 浮遊する立方体群 (空間の広がり) ---
        function setupModeB() {
            for(let i=0; i<100; i++) {
                const box = new THREE.Mesh(new THREE.BoxGeometry(2,2,2), new THREE.MeshBasicMaterial({wireframe:true}));
                box.position.set((Math.random()-0.5)*100, (Math.random()-0.5)*100, -Math.random()*200);
                groups.B.add(box);
            }
        }

        // --- モード X: 地平線のグリッド (安定感抜群) ---
        function setupModeX() {
            const grid = new THREE.GridHelper(200, 40, 0xffffff, 0x444444);
            grid.position.y = -10;
            groups.X.add(grid);
            const sphere = new THREE.Mesh(new THREE.SphereGeometry(5, 32, 32), new THREE.MeshBasicMaterial({wireframe:true}));
            sphere.position.z = -30;
            groups.X.add(sphere);
        }

        // --- モード Y: 音の波形リング (前方に集中) ---
        function setupModeY() {
            for(let i=0; i<20; i++) {
                const ring = new THREE.Mesh(new THREE.TorusGeometry(10 + i, 0.1, 16, 100), new THREE.MeshBasicMaterial());
                ring.position.z = -i * 10;
                groups.Y.add(ring);
            }
        }

        function switchMode(m) {
            currentMode = m;
            Object.keys(groups).forEach(key => groups[key].visible = (key === m));
            document.getElementById('mode-info').innerText = "Mode: " + m;
        }

        // コントローラー入力
        renderer.xr.getController(0).addEventListener('selectstart', () => {}); // 予備

        renderer.setAnimationLoop(() => {
            const session = renderer.xr.getSession();
            if (session) {
                for (const source of session.inputSources) {
                    if (source.gamepad) {
                        const b = source.gamepad.buttons;
                        if (b[4]?.pressed || b[0]?.pressed) switchMode('A'); // A or Left Trigger
                        if (b[5]?.pressed || b[1]?.pressed) switchMode('B'); // B or Right Trigger
                        if (source.handedness === 'left' && b[4]?.pressed) switchMode('X'); // X
                        if (source.handedness === 'left' && b[5]?.pressed) switchMode('Y'); // Y
                    }
                }
            }

            if (analyzer) {
                analyzer.getByteFrequencyData(dataArray);
                const low = dataArray[5]/255, mid = dataArray[20]/255, high = dataArray[60]/255;
                hueBase += 0.002;

                if (currentMode === 'A') {
                    groups.A.children[0].scale.set(1+low, 1, 1+low);
                    groups.A.children[0].material.color.setHSL((hueBase + mid)%1, 0.8, 0.5);
                    groups.A.children[0].position.z = (Date.now()*0.02) % 100;
                } else if (currentMode === 'B') {
                    groups.B.children.forEach((c, i) => {
                        c.rotation.y += 0.01 + low*0.1;
                        c.material.color.setHSL((hueBase + i*0.01 + high)%1, 1, 0.5);
                        c.scale.setScalar(1 + mid*2);
                    });
                } else if (currentMode === 'X') {
                    groups.X.children[1].scale.setScalar(1 + low*3);
                    groups.X.children[1].material.color.setHSL(hueBase%1, 1, 0.5);
                    groups.X.children[0].position.z = (Date.now()*0.05) % 5;
                } else if (currentMode === 'Y') {
                    groups.Y.children.forEach((c, i) => {
                        const s = 1 + (dataArray[i*5]||0)/255 * 2;
                        c.scale.set(s, s, 1);
                        c.material.color.setHSL((hueBase + i*0.05)%1, 0.8, 0.5);
                    });
                }
            }
            renderer.render(scene, camera);
        });
    </script>
</body>
</html>
