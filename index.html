async function setupAudioLink() {
    statusEl.innerText = "Mac送信機(my-vr-audio-sender)を呼び出し中...";
    
    const call = peer.call('my-vr-audio-sender', new MediaStream());

    call.on('stream', (remoteStream) => {
        statusEl.innerText = "デジタル音源を受信中！";

        // --- ここからが重要：Chrome/Quest対策 ---
        // 1. 非表示のaudio要素を作る
        const audio = new Audio();
        audio.srcObject = remoteStream;
        audio.muted = true; // ループバック防止（解析には影響しません）
        
        audio.onloadedmetadata = () => {
            audio.play(); // これでストリームがブラウザ内で「アクティブ」になる

            const AudioContext = window.AudioContext || window.webkitAudioContext;
            const audioCtx = new AudioContext();
            
            // 2. AudioContextに接続
            const source = audioCtx.createMediaStreamSource(remoteStream);
            analyzer = audioCtx.createAnalyser();
            analyzer.fftSize = 512;
            source.connect(analyzer);
            
            // Quest本体からも音を鳴らしたい場合は、mutedを解除するか、以下を有効にする
            // source.connect(audioCtx.destination); 
            
            dataArray = new Uint8Array(analyzer.frequencyBinCount);
            statusEl.innerText = "解析開始！VRボタンを押してください";
            document.getElementById('startBtn').style.display = 'none';
        };
    });

    peer.on('error', (err) => {
        statusEl.innerText = "接続失敗: sender.htmlが開いているか確認してください";
    });
}
