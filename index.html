<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Psy-AR 12-Patterns</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; }
        #arBtn { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); padding: 60px 100px; font-size: 30px; background: #ff00ff; color: #fff; border: none; border-radius: 20px; z-index: 1000; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <button id="arBtn">START PSY-AR</button>
    <audio id="audio" autoplay playsinline></audio>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script>
        let scene, camera, renderer, mesh, xrRefSpace, geometries = [];
        let macData = { low: 0, mid: 0, trigger: false };
        let currentIdx = 0, lastSwitch = 0, hue = 0;
        const audio = document.getElementById('audio');

        window.onclick = () => { if (audio.srcObject) audio.play(); };

        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);
        renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true });
        renderer.xr.enabled = true;
        
        // Generate 12 Patterns
        geometries = [
            new THREE.TorusKnotGeometry(0.5, 0.15, 128, 16), new THREE.IcosahedronGeometry(0.5, 1),
            new THREE.TorusGeometry(0.6, 0.1, 16, 100), new THREE.BoxGeometry(0.6, 0.6, 0.6, 4, 4, 4),
            new THREE.OctahedronGeometry(0.6, 0), new THREE.DodecahedronGeometry(0.6, 0),
            new THREE.SphereGeometry(0.5, 32, 32), new THREE.CylinderGeometry(0.4, 0.4, 0.8, 32),
            new THREE.TorusKnotGeometry(0.5, 0.05, 150, 3, 3, 5), new THREE.ConeGeometry(0.5, 1, 32),
            new THREE.TorusGeometry(0.5, 0.2, 8, 6), new THREE.CapsuleGeometry(0.3, 0.6, 4, 16)
        ];
        mesh = new THREE.Mesh(geometries[0], new THREE.MeshBasicMaterial({ wireframe: true, transparent: true, opacity: 0.8 }));
        scene.add(mesh);

        const btn = document.getElementById('arBtn');
        btn.onclick = () => {
            navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['local-floor', 'hand-tracking'] }).then(session => {
                btn.style.display = 'none';
                renderer.xr.setSession(session);
                session.requestReferenceSpace('local-floor').then(ref => { xrRefSpace = ref; initPeer(); renderer.setAnimationLoop(render); });
            });
        };

        function initPeer() {
            const peer = new Peer('quest-receiver');
            peer.on('connection', conn => conn.on('data', data => macData = data));
            peer.on('call', call => {
                call.answer(new MediaStream());
                call.on('stream', stream => { audio.srcObject = stream; audio.play(); });
            });
        }

        function render(time, frame) {
            if (!frame || !xrRefSpace) return;
            hue += 0.005;

            // Trigger Shape Change
            if (macData.trigger && Date.now() - lastSwitch > 600) {
                currentIdx = (currentIdx + 1) % geometries.length;
                mesh.geometry = geometries[currentIdx];
                lastSwitch = Date.now();
            }

            // Capture Head Direction (Look At)
            const lookVector = new THREE.Vector3(0, 0, -1).applyQuaternion(camera.quaternion);
            mesh.rotation.x += lookVector.y * 0.1; // Rotate based on vertical gaze
            mesh.rotation.z += lookVector.x * 0.1; // Rotate based on horizontal gaze

            // Hand Tracking with Look-based Offset
            for (const input of frame.session.inputSources) {
                if (input.hand) {
                    const pose = frame.getJointPose(input.hand.get('index-finger-tip'), xrRefSpace);
                    if (pose) {
                        const targetPos = new THREE.Vector3().copy(pose.transform.position);
                        // Add slight push based on where you look
                        targetPos.add(lookVector.multiplyScalar(0.1));
                        mesh.position.lerp(targetPos, 0.2);
                    }
                }
            }

            // Audio Visuals
            mesh.scale.setScalar(1 + macData.low * 2.5);
            mesh.material.color.setHSL((hue + macData.mid) % 1, 1, 0.5 + macData.low * 0.2);
            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
