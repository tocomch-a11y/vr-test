<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Psy-XR Final System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <style>
        body { margin: 0; background: #000; overflow: hidden; font-family: monospace; }
        #ui { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #000; z-index: 1000; }
        #arBtn { padding: 40px 80px; font-size: 32px; background: #333; color: #fff; border: none; border-radius: 15px; cursor: not-allowed; transition: 0.3s; }
        #arBtn.ready { background: #00ffff; color: #000; cursor: pointer; box-shadow: 0 0 30px #00ffff; }
        #status { color: #0f0; margin-top: 20px; font-size: 18px; text-align: center; }
    </style>
</head>
<body>
    <div id="ui">
        <button id="arBtn" disabled>WAITING FOR MAC...</button>
        <div id="status">INIT PEER...</div>
    </div>
    <audio id="remoteAudio" autoplay></audio>

    <script>
        const btn = document.getElementById('arBtn');
        const status = document.getElementById('status');
        let macData = { low: 0, mid: 0, high: 0, trigger: false };
        let renderer, scene, camera, mesh, geometries = [];
        let currentIdx = 0, lastSwitch = 0, hue = 0;

        // 1. Peer Setup
        const peer = new Peer('quest-receiver');
        peer.on('open', (id) => { status.innerText = "READY. RUN MAC SENDER NOW."; });
        peer.on('connection', conn => {
            status.innerText = "MAC CONNECTED! CLICK START AR.";
            btn.disabled = false; btn.classList.add('ready'); btn.innerText = "START AR";
            conn.on('data', data => { macData = data; });
        });
        peer.on('call', call => {
            call.answer(new MediaStream());
            call.on('stream', stream => { document.getElementById('remoteAudio').srcObject = stream; });
        });

        // 2. XR Setup
        btn.onclick = () => {
            navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['local-floor', 'hand-tracking'] }).then(setupXR);
        };

        function setupXR(session) {
            document.getElementById('ui').style.display = 'none';
            renderer = new THREE.WebGLRenderer({ antialias: false, alpha: true });
            renderer.xr.enabled = true;
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.setSession(session);

            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.1, 100);

            createGeos();
            const mat = new THREE.MeshBasicMaterial({ wireframe: true, transparent: true, opacity: 0.8 });
            mesh = new THREE.Mesh(geometries[0], mat);
            scene.add(mesh);

            renderer.setAnimationLoop(render);
        }

        function createGeos() {
            geometries = [
                new THREE.TorusKnotGeometry(1, 0.4, 128, 16),
                new THREE.IcosahedronGeometry(1.5, 2),
                new THREE.TorusGeometry(2, 0.1, 16, 100),
                new THREE.OctahedronGeometry(1.5, 5),
                new THREE.TorusKnotGeometry(1.5, 0.1, 200, 3, 3, 5),
                new THREE.BoxGeometry(2, 2, 2, 10, 10, 10),
                new THREE.DodecahedronGeometry(1.5, 1),
                new THREE.TorusGeometry(1.5, 0.6, 12, 64),
                new THREE.SphereGeometry(1.5, 64, 32),
                new THREE.ConeGeometry(1.5, 3, 32, 20, true),
                new THREE.TorusKnotGeometry(1.2, 0.5, 128, 8, 5, 2),
                new THREE.CapsuleGeometry(0.8, 2, 8, 16)
            ];
        }

        function render(time, frame) {
            hue += 0.003 + (macData.high * 0.05);

            if (macData.trigger && Date.now() - lastSwitch > 600) {
                currentIdx = Math.floor(Math.random() * 12);
                mesh.geometry = geometries[currentIdx];
                lastSwitch = Date.now();
            }

            if (frame) {
                const sources = frame.session.inputSources;
                for (const input of sources) {
                    if (input.hand) {
                        const tip = frame.getJointPose(input.hand.get('index-finger-tip'), renderer.xr.getReferenceSpace());
                        const wrist = frame.getJointPose(input.hand.get('wrist'), renderer.xr.getReferenceSpace());
                        if (tip && wrist) {
                            const tPos = tip.transform.position;
                            const tOri = tip.transform.orientation;
                            mesh.position.lerp(new THREE.Vector3(tPos.x, tPos.y, tPos.z), 0.2);
                            mesh.quaternion.slerp(new THREE.Quaternion(tOri.x, tOri.y, tOri.z, tOri.w), 0.1);
                            const dist = Math.hypot(tPos.x - wrist.transform.position.x, tPos.y - wrist.transform.position.y);
                            mesh.scale.setScalar(0.4 + (dist * 8) + (macData.low * 3));
                        }
                    }
                }
            }

            mesh.rotation.y += 0.01 + macData.high * 0.1;
            mesh.material.color.setHSL((hue + macData.mid) % 1, 0.9, 0.5 + macData.low * 0.2);
            mesh.material.opacity = 0.3 + (macData.low * 0.7);

            renderer.render(scene, camera);
        }
    </script>
</body>
</html>
