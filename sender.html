<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Mac Audio Sender - Device Select</title>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #111; color: white; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        select { padding: 10px; font-size: 16px; margin-bottom: 20px; width: 300px; }
        button { padding: 20px 40px; font-size: 20px; cursor: pointer; background: #00ff00; border: none; border-radius: 10px; font-weight: bold; }
        #status { margin-top: 20px; color: #00ffff; }
    </style>
</head>
<body>
    <h1>Mac音源 配信機</h1>
    <select id="audioSource"></select><br>
    <button id="startBtn">1. デバイス読み込み</button>
    <div id="status">ID: my-vr-audio-sender で待機します</div>

    <script>
        const peer = new Peer('my-vr-audio-sender');
        const audioSelect = document.getElementById('audioSource');
        const startBtn = document.getElementById('startBtn');
        let localStream;

        // デバイス一覧を取得
        async function getDevices() {
            const devices = await navigator.mediaDevices.enumerateDevices();
            audioSelect.innerHTML = '';
            devices.filter(d => d.kind === 'audioinput').forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.deviceId;
                opt.text = d.label || `Microphone ${audioSelect.length + 1}`;
                audioSelect.appendChild(opt);
            });
            startBtn.innerText = "2. 配信開始";
        }

        startBtn.onclick = async () => {
            if (audioSelect.length === 0) {
                // 初回クリックでマイク許可を求めてからデバイスリストを作る
                await navigator.mediaDevices.getUserMedia({ audio: true });
                await getDevices();
                return;
            }

            const constraints = {
                audio: { deviceId: audioSelect.value ? { exact: audioSelect.value } : undefined }
            };

            localStream = await navigator.mediaDevices.getUserMedia(constraints);
            
            peer.on('call', (call) => {
                console.log("Questから着信！");
                call.answer(localStream); 
            });

            document.getElementById('status').innerText = "配信中... Quest側をリロードしてください";
            startBtn.disabled = true;
            startBtn.style.background = "#555";
        };
    </script>
</body>
</html>
