<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Mac Audio Sender - Stable Link</title>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: white; text-align: center; padding: 50px; }
        .container { background: #333; padding: 30px; border-radius: 20px; display: inline-block; }
        button { padding: 20px 40px; font-size: 20px; cursor: pointer; background: #00ff88; border: none; border-radius: 10px; font-weight: bold; }
        #status { margin-top: 20px; color: #00ffff; font-family: monospace; font-size: 1.2em; }
        .id-text { color: #ff00ff; font-weight: bold; font-size: 1.5em; background: #000; padding: 5px 10px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Mac音源 送信機</h1>
        <p>1. Macの出力を「VB-CABLE」を含む複数出力にする</p>
        <button id="startBtn">2. 配信開始 (VB-CABLEを選択)</button>
        <div id="status">Peer接続を待機中...</div>
        <p>Questに入力するID: <span class="id-text">mac-audio-test</span></p>
    </div>

    <script>
        // IDを 'mac-audio-test' に固定
        const peer = new Peer('mac-audio-test');

        peer.on('open', (id) => {
            document.getElementById('status').innerText = "準備完了。Questから接続してください。";
        });

        document.getElementById('startBtn').onclick = async () => {
            try {
                // VB-CABLE(またはBlackHole)の音を取得
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false
                    } 
                });

                // Questからの電話を待ち受ける
                peer.on('call', (call) => {
                    console.log("Questが接続しました！音声を送信します。");
                    call.answer(stream); // Questに音声を送る
                });

                document.getElementById('startBtn').style.background = "#555";
                document.getElementById('startBtn').innerText = "配信中...";
                document.getElementById('status').innerText = "配信中です。Quest側でIDを入力して起動してください。";
            } catch (err) {
                console.error(err);
                alert("エラー: ブラウザのマイク許可で VB-CABLE を選択してください。");
            }
        };

        // エラーハンドリング
        peer.on('error', (err) => {
            if (err.type === 'unavailable-id') {
                document.getElementById('status').innerText = "エラー: IDが既に使用されています。別タブで開いていないか確認してください。";
            } else {
                console.error(err);
            }
        });
    </script>
</body>
</html>
