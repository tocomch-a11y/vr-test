<!DOCTYPE html>
<html>
<body style="background:#111; color:white; font-family:sans-serif; text-align:center; padding:50px;">
    <h1>MAC SENDER</h1>
    <button id="btn" style="padding:25px; font-size:20px; cursor:pointer; background:#00ff00;">1. START & CONNECT</button>
    <p id="status">Status: Waiting for click</p>

    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script>
        const peer = new Peer('mac-sender-' + Math.floor(Math.random()*1000)); // Unique ID for Mac
        let dataConn;

        document.getElementById('btn').onclick = async () => {
            document.getElementById('status').innerText = "Accessing Microphone...";
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            
            const ctx = new AudioContext();
            const source = ctx.createMediaStreamSource(stream);
            const analyzer = ctx.createAnalyser();
            analyzer.fftSize = 256;
            source.connect(analyzer);
            const data = new Uint8Array(analyzer.frequencyBinCount);

            document.getElementById('status').innerText = "Connecting to Quest...";
            
            // Call and Data connection to specific Quest ID
            peer.call('quest-receiver', stream);
            dataConn = peer.connect('quest-receiver');

            dataConn.on('open', () => {
                document.getElementById('status').innerText = "!!! CONNECTED TO QUEST !!!";
                function loop() {
                    analyzer.getByteFrequencyData(data);
                    if (dataConn.open) {
                        dataConn.send({
                            low: data[4]/255,
                            mid: data[15]/255,
                            high: data[30]/255,
                            trigger: data[4] > 200
                        });
                    }
                    requestAnimationFrame(loop);
                }
                loop();
            });

            dataConn.on('error', (err) => {
                document.getElementById('status').innerText = "Connection Error: " + err;
            });
        };
    </script>
</body>
</html>
